#include "stdlib.h"
#include "contiki.h"
#include <stdio.h>
#include <math.h>

# define transformation_lenght 8 
# define signal_lenght 512
# define NAN (0.0/0.0)

 static const double S[] = {
   0.353553390593273762200422,
   0.254897789552079584470970,
   0.270598050073098492199862,
   0.300672443467522640271861,
   0.353553390593273762200422,
   0.449988111568207852319255,
   0.653281482438188263928322,
   1.281457723870753089398043,
 };

 static const double A[] = {
   NAN,
   0.707106781186547524400844,
   0.541196100146196984399723,
   0.707106781186547524400844,
   1.306562964876376527856643,
   0.382683432365089771728460,
 };

float ecg_signal[signal_lenght] = {0.35, 0.35, 0.35, 0.35, 0.35, 0.35, 0.35, 0.35, 0.35, 0.02, -0.21, -0.33, -0.37, -0.335, -0.285, -0.23, -0.215, -0.2, -0.19, -0.2, -0.2, -0.21, -0.23, -0.25, -0.255, -0.245, -0.24, -0.215, -0.235, -0.23, -0.23, -0.205, -0.18, -0.165, -0.195, -0.21, -0.215, -0.195, -0.17, -0.155, -0.175, -0.195, -0.21, -0.2, -0.2, -0.195, -0.185, -0.185, -0.18, -0.175, -0.175, -0.165, -0.14, -0.12, -0.115, -0.13, -0.155, -0.19, -0.19, -0.185, -0.18, -0.16, -0.14, -0.13, -0.11, -0.12, -0.13, -0.13, -0.125, -0.095, -0.095, -0.09, -0.08, -0.075, -0.07, -0.075, -0.065, -0.055, -0.06, -0.055, -0.04, -0.03, -0.02, -0.015, -0.015, -0.01, 0.015, 0.035, 0.025, 0.015, 0.015, 0.025, 0.025, 0.04, 0.04, 0.03, 0.015, 0.02, 0.035, 0.045, 0.05, 0.025, 0.02, 0.02, 0.01, 0.01, 0, -0.005, -0.025, -0.02, -0.03, -0.03, -0.035, -0.045, -0.055, -0.06, -0.065, -0.075, -0.08, -0.075, -0.075, -0.075, -0.07, -0.075, -0.08, -0.09, -0.1, -0.095, -0.095, -0.085, -0.095, -0.1, -0.1, -0.115, -0.115, -0.13, -0.14, -0.15, -0.16, -0.145, -0.155, -0.16, -0.17, -0.185, -0.175, -0.17, -0.165, -0.17, -0.17, -0.165, -0.18, -0.18, -0.2, -0.2, -0.215, -0.205, -0.21, -0.205, -0.21, -0.22, -0.225, -0.225, -0.24, -0.225, -0.21, -0.205, -0.195, -0.19, -0.2, -0.19, -0.19, -0.185, -0.17, -0.17, -0.175, -0.165, -0.165, -0.185, -0.185, -0.205, -0.205, -0.21, -0.195, -0.195, -0.19, -0.195, -0.195, -0.195, -0.185, -0.175, -0.175, -0.2, -0.225, -0.25, -0.24, -0.24, -0.24, -0.25, -0.26, -0.27, -0.28, -0.305, -0.335, -0.35, -0.34, -0.285, -0.205, -0.135, -0.095, -0.045, 0.01, 0.075, 0.14, 0.175, 0.135, 0.045, -0.155, -0.425, -0.71, -0.915, -1.09, -1.255, -1.395, -1.465, -1.505, -1.49, -1.45, -1.39, -1.34, -1.27, -1.155, -1.025, -0.95, -0.93, -0.93, -0.91, -0.885, -0.865, -0.84, -0.8, -0.755, -0.715, -0.66, -0.63, -0.58, -0.54, -0.51, -0.465, -0.435, -0.395, -0.365, -0.315, -0.265, -0.2, -0.155, -0.09, -0.04, -0.015, -0.01, 0.005, 0.03, 0.055, 0.08, 0.085, 0.09, 0.11, 0.11, 0.13, 0.15, 0.155, 0.15, 0.18, 0.185, 0.205, 0.22, 0.235, 0.235, 0.255, 0.27, 0.29, 0.29, 0.3, 0.3, 0.305, 0.325, 0.315, 0.31, 0.315, 0.315, 0.345, 0.36, 0.37, 0.375, 0.375, 0.365, 0.375, 0.385, 0.41, 0.405, 0.4, 0.4, 0.405, 0.4, 0.41, 0.395, 0.4, 0.385, 0.39, 0.395, 0.385, 0.38, 0.355, 0.355, 0.355, 0.35, 0.325, 0.3, 0.28, 0.25, 0.25, 0.25, 0.25, 0.235, 0.21, 0.175, 0.165, 0.16, 0.145, 0.14, 0.145, 0.13, 0.1, 0.08, 0.04, 0.015, -0.01, -0.025, -0.025, -0.03, -0.04, -0.045, -0.07, -0.105, -0.08, -0.075, -0.085, -0.09, -0.11, -0.13, -0.12, -0.115, -0.125, -0.15, -0.17, -0.16, -0.16, -0.15, -0.155, -0.16, -0.17, -0.185, -0.18, -0.18, -0.19, -0.18, -0.17, -0.16, -0.14, -0.14, -0.145, -0.17, -0.18, -0.175, -0.16, -0.155, -0.155, -0.165, -0.15, -0.155, -0.15, -0.145, -0.145, -0.165, -0.195, -0.205, -0.19, -0.18, -0.165, -0.17, -0.16, -0.17, -0.165, -0.17, -0.17, -0.17, -0.17, -0.185, -0.19, -0.18, -0.18, -0.18, -0.175, -0.2, -0.21, -0.2, -0.2, -0.21, -0.215, -0.21, -0.2, -0.175, -0.16, -0.145, -0.145, -0.135, -0.14, -0.135, -0.13, -0.12, -0.115, -0.11, -0.105, -0.1, -0.095, -0.11, -0.14, -0.175, -0.18, -0.18, -0.18, -0.165, -0.175, -0.175, -0.175, -0.165, -0.165, -0.165, -0.175, -0.165, -0.16, -0.155, -0.15, -0.155, -0.16, -0.16, -0.155, -0.145, -0.15, -0.15, -0.185, -0.2, -0.2, -0.195, -0.19, -0.19, -0.195, -0.2, -0.195, -0.185, -0.175, -0.175, -0.155, -0.17, -0.17, -0.165, -0.15, -0.16, -0.165, -0.175, -0.17, -0.17, -0.185, -0.215, -0.225, -0.19, -0.125, -0.04, 0.05, 0.125, 0.215, 0.32, 0.415, 0.5, 0.605, 0.725, 0.845, 0.94, 1.06, 1.11, 1.1, 1.005, 0.86, 0.615, 0.24, -0.11, -0.335, -0.46, -0.515, -0.54, -0.51, -0.44, -0.385, -0.36, -0.35, -0.335, -0.32, -0.295, -0.3, -0.3, -0.325, -0.335, -0.335};


void DCT(float vector[static 8]) {
   const float v0 = vector[0] + vector[7];
   const float v1 = vector[1] + vector[6];
   const float v2 = vector[2] + vector[5];
   const float v3 = vector[3] + vector[4];
   const float v4 = vector[3] - vector[4];
   const float v5 = vector[2] - vector[5];
   const float v6 = vector[1] - vector[6];
   const float v7 = vector[0] - vector[7];
  
   const float v8 = v0 + v3;
   const float v9 = v1 + v2;
   const float v10 = v1 - v2;
   const float v11 = v0 - v3;
   const float v12 = -v4 - v5;
   const float v13 = (v5 + v6) * A[3];
   const float v14 = v6 + v7;
  
   const float v15 = v8 + v9;
   const float v16 = v8 - v9;
   const float v17 = (v10 + v11) * A[1];
   const float v18 = (v12 + v14) * A[5];
  
   const float v19 = -v12 * A[2] - v18;
   const float v20 = v14 * A[4] - v18;
  
   const float v21 = v17 + v11;
   const float v22 = v11 - v17;
   const float v23 = v13 + v7;
   const float v24 = v7 - v13;
  
   const float v25 = v19 + v24;
   const float v26 = v23 + v20;
   const float v27 = v23 - v20;
   const float v28 = v24 - v19;
  
   vector[0] = S[0] * v15;
   vector[1] = S[1] * v26;
   vector[2] = S[2] * v21;
   vector[3] = S[3] * v28;
   vector[4] = S[4] * v16;
   vector[5] = S[5] * v25;
   vector[6] = S[6] * v22;
   vector[7] = S[7] * v27;
}

void print_float(float value)
{
    char flag = ' ';    
    int temp,temp2;
    temp = (int)value;
    temp2 = (int)((value-temp)*10000);
    if(temp < 0 || temp2 < 0){
      flag = '-';
    }
    printf("The result is: %c%d.%04d\n",flag,abs(temp),abs(temp2));
}

/*---------------------------------------------------------------------------*/
PROCESS(fast_dct_process, "fast_dct_process");
AUTOSTART_PROCESSES(&fast_dct_process);
/*---------------------------------------------------------------------------*/
PROCESS_THREAD(fast_dct_process, ev, data)
{
  PROCESS_BEGIN();
  unsigned long start = clock_time();
  int i,j;

  for(i = 0; i < signal_lenght/transformation_lenght; i++){
     DCT(ecg_signal+(i*transformation_lenght));
     for(j = 0; j < 8; j++){
       print_float((ecg_signal+(i*transformation_lenght))[j]);
     }
    }

  unsigned long end = clock_time();
  printf("Time for completing: %lu ms\n", end - start);
  PROCESS_END();
}
/*---------------------------------------------------------------------------*/